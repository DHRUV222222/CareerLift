{% extends 'mentor/base.html' %}
{% load static %}

{% block title %}Manage Availability - CareerLift{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <form method="post" action="{% url 'core:mentor_availability' %}">
        {% csrf_token %}
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Manage Your Availability</h1>
                <a href="{% url 'core:mentor_dashboard' %}" 
                   class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                    &larr; Back to Dashboard
                </a>
            </div>
            
            {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                <div class="p-4 mb-4 text-sm rounded-lg {% if message.tags %}{{ message.tags }}{% endif %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}bg-green-100 text-green-700{% endif %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}bg-red-100 text-red-700{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
                <div class="px-4 py-5 sm:px-6 bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Weekly Availability
                            </h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                Set your regular weekly availability. Students will be able to book sessions during these times.
                            </p>
                        </div>
                        <button type="button" id="add-time-slot" 
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-1 mr-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Time Slot
                        </button>
                    </div>
                </div>
                
                <div class="px-4 py-5 sm:p-6">
                    {{ formset.management_form }}
                    <div id="time-slots">
                        {% for form in formset %}
                        <div class="time-slot-form mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div class="flex flex-wrap -mx-2">
                                <div class="w-full sm:w-1/2 md:w-1/4 lg:w-1/5 px-2 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                                    <div class="mt-1">
                                        {{ form.day_of_week }}
                                    </div>
                                </div>
                                <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                    <div class="mt-1">
                                        {{ form.start_time }}
                                    </div>
                                </div>
                                <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                    <div class="mt-1">
                                        {{ form.end_time }}
                                    </div>
                                </div>
                                <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4 flex items-center">
                                    <div class="flex items-center h-10">
                                        <div class="flex items-center h-5">
                                            {{ form.is_recurring }}
                                        </div>
                                        <label for="{{ form.is_recurring.id_for_label }}" class="ml-2 block text-sm text-gray-700">
                                            Recurring
                                        </label>
                                    </div>
                                </div>
                                <div class="w-full sm:w-1/4 md:w-1/5 px-2 mb-4 flex items-center justify-end">
                                    <div class="relative">
                                        <button type="button" class="delete-slot w-full sm:w-auto inline-flex justify-center items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-150">
                                            <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                            <span>Delete</span>
                                        </button>
                                        {% if form.DELETE %}
                                            {{ form.DELETE }}
                                        {% else %}
                                            <input type="hidden" name="availability-{{ forloop.counter0 }}-DELETE" id="id_availability-{{ forloop.counter0 }}-DELETE">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% for hidden in form.hidden_fields %}
                                {% if hidden.name != 'DELETE' %}
                                    {{ hidden }}
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if formset.non_form_errors %}
                        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-red-700">
                                        Please correct the errors below.
                                    </p>
                                    <div class="mt-2 text-sm text-red-700">
                                        {{ formset.non_form_errors }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="mt-8 pt-5 border-t border-gray-200">
                <div class="flex justify-between">
                    <a href="{% url 'core:mentor_dashboard' %}" 
                       class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        &larr; Back to Dashboard
                    </a>
                    <div>
                        <button type="submit" 
                                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Availability
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to handle delete button click
    function handleDeleteClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const form = e.target.closest('.time-slot-form');
        if (!form) return;
        
        // Add deleting class to prevent validation issues
        form.classList.add('deleting');
        
        // Find the delete input (could be checkbox or hidden)
        const deleteInput = form.querySelector('input[type="checkbox"][id$="-DELETE"], input[type="hidden"][id$="-DELETE"]');
        
        if (deleteInput) {
            if (deleteInput.type === 'checkbox') {
                // For existing records, mark for deletion
                deleteInput.checked = true;
                form.style.opacity = '0.5';
                form.style.pointerEvents = 'none';
            } else {
                // For new forms, remove the element with animation
                form.style.transition = 'all 0.3s ease-in-out';
                form.style.maxHeight = '0';
                form.style.opacity = '0';
                form.style.marginBottom = '0';
                form.style.padding = '0';
                form.style.overflow = 'hidden';
                
                setTimeout(() => {
                    form.remove();
                    updateFormIndices();
                }, 300);
            }
        }
        
        // Update form indices after deletion
        updateFormIndices();
    }
    
    // Function to update form indices for proper form submission
    function updateFormIndices() {
        const forms = document.querySelectorAll('.time-slot-form');
        const totalForms = document.getElementById('id_availability-TOTAL_FORMS');
        
        if (totalForms) {
            totalForms.value = forms.length;
        }
        
        forms.forEach((form, index) => {
            // Update form IDs and names
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name) {
                    input.name = input.name.replace(/availability-\d+-/, `availability-${index}-`);
                }
                if (input.id) {
                    input.id = input.id.replace(/id_availability-\d+-/, `id_availability-${index}-`);
                }
            });
            
            // Update labels 'for' attributes
            const labels = form.querySelectorAll('label');
            labels.forEach(label => {
                if (label.htmlFor) {
                    label.htmlFor = label.htmlFor.replace(/id_availability-\d+-/, `id_availability-${index}-`);
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize delete buttons for existing forms
        document.querySelectorAll('.delete-slot').forEach(btn => {
            btn.addEventListener('click', handleDeleteClick);
        });
        
        // Add new time slot
        document.getElementById('add-time-slot').addEventListener('click', function(e) {
            e.preventDefault();
            const formCount = document.getElementById('id_availability-TOTAL_FORMS');
            const formNum = parseInt(formCount.value);
            const container = document.getElementById('time-slots');
            
            // Create a new form from the empty form template
            const newForm = document.createElement('div');
            newForm.className = 'time-slot-form mb-4 p-4 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 transition-colors duration-200';
            
            // Get the template and replace the prefix
            const template = document.getElementById('empty-form').innerHTML;
            newForm.innerHTML = template.replace(/__prefix__/g, formNum);
            
            // Add to the container
            container.appendChild(newForm);
            formCount.value = formNum + 1;
            
            // Initialize time inputs with default values
            const timeInputs = newForm.querySelectorAll('input[type="time"]');
            if (timeInputs[0]) timeInputs[0].value = '09:00'; // start time
            if (timeInputs[1]) timeInputs[1].value = '10:00'; // end time
            
            // Initialize select field
            const daySelect = newForm.querySelector('select');
            if (daySelect) daySelect.selectedIndex = 0;
            
            // Initialize delete button for the new form
            const deleteBtn = newForm.querySelector('.delete-slot');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleDeleteClick);
            }
            
            // Re-index all forms
            updateFormIndices();
        });
        
        // Handle form submission
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Ensure all time inputs have values before submission
                const timeInputs = form.querySelectorAll('input[type="time"]');
                let isValid = true;
                
                timeInputs.forEach((input, index) => {
                    const formGroup = input.closest('.time-slot-form');
                    // Only validate visible forms (not marked for deletion)
                    if (formGroup && !formGroup.classList.contains('deleting')) {
                        if (!input.value) {
                            isValid = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                        }
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all time fields');
                    return false;
                }
                
                // Update form indices before submission
                updateFormIndices();
                return true;
            });
        }
        
        // Update form indices for proper form submission
        function updateFormIndices() {
            const forms = document.querySelectorAll('.time-slot-form');
            const formCount = document.getElementById('id_availability-TOTAL_FORMS');
            formCount.value = forms.length;
            
            forms.forEach((form, index) => {
                // Update all field names and IDs with the new index
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.name.replace(/availability-\d+/, `availability-${index}`);
                    const id = input.id.replace(/id_availability-\d+/, `id_availability-${index}`);
                    input.name = name;
                    input.id = id;
                });
                
                // Update labels
                const labels = form.querySelectorAll('label');
                labels.forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        label.setAttribute('for', forAttr.replace(/id_availability-\d+/, `id_availability-${index}`));
                    }
                });
            });
        }
    });
</script>

<!-- Empty form template for adding new time slots -->
<template id="empty-form">
    <div class="time-slot-form mb-4 p-4 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 transition-colors duration-200">
        <div class="flex flex-wrap -mx-2">
            <div class="w-full sm:w-1/2 md:w-1/4 lg:w-1/5 px-2 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                <select name="availability-__prefix__-day_of_week" id="id_availability-__prefix__-day_of_week" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% for value, label in days_of_week.items %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                <input type="time" name="availability-__prefix__-start_time" id="id_availability-__prefix__-start_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                <input type="time" name="availability-__prefix__-end_time" id="id_availability-__prefix__-end_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div class="w-1/2 sm:w-1/4 md:w-1/5 px-2 mb-4 flex items-center">
                <div class="flex items-center h-10">
                    <div class="flex items-center h-5">
                        <input type="checkbox" name="availability-__prefix__-is_recurring" id="id_availability-__prefix__-is_recurring" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                    </div>
                    <label for="id_availability-__prefix__-is_recurring" class="ml-2 block text-sm text-gray-700">
                        Recurring
                    </label>
                </div>
            </div>
            <div class="w-full sm:w-1/4 md:w-1/5 px-2 mb-4 flex items-center justify-end">
                <div class="relative">
                    <button type="button" class="delete-slot w-full sm:w-auto inline-flex justify-center items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-150">
                        <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <span>Delete</span>
                    </button>
                    <input type="hidden" name="availability-__prefix__-DELETE" id="id_availability-__prefix__-DELETE">
                </div>
            </div>
        </div>
        <input type="hidden" name="availability-__prefix__-id" id="id_availability-__prefix__-id">
        <input type="hidden" name="availability-__prefix__-mentor" id="id_availability-__prefix__-mentor" value="{{ mentor.pk }}">
    </div>
</template>
{% endblock %}
